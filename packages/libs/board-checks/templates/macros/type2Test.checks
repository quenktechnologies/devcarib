{#

  optional

  Makes a precondition optional.
  @param {Schema} type
  @param {Output} content

#}
{% macro optional (type, content) %}

  {%- if type.optional -%}
    {%- if isObjectType(type) -%}
      _optional<any, {{type.title}}>({{content}})
    {%- else -%}
      _optional({{content}})
    {%- endif %}
  {%- else -%}
    {{content}}
  {%- endif -%}

{% endmacro %}

{# 
  Turns an array schema into a precondition. 
  
  @param {Schema} type
  @param {Precondition} recordFn

#}
{% macro arrayType2Test(type, recordFun) %}

  {% set content -%}
    _map({{type2Test(type.items, recordFun)}})
  {%- endset %}

  {% if hasTest(type) -%}
   {% set content -%}
   _and({{content}}, {{getTest(type)}})
   {%- endset %}
  {% endif %}

  {{optional(type, content)}}

{% endmacro %}

{# turns an object schema into a record of preconditions
  
  @param {Schema} type
#}
{% macro objectType2Test (type, recordFun) %}

  {% if isObject(type.additionalProperties) %}

    {%- set content -%}
       _recordMap<Value, Value, {{type.title}}>(
       {{anyType2Test(type.additionalProperties)}})
    {%- endset -%}

  {% elseif isObject(type.properties) %}

    {%- set content -%}
       _record<Value, Value, {{type.title}}>({
        {% for key,value in type.properties %}
          {% if (not value.readOnly) or hasTest(value)  %}
            '{{key}}' : {{type2Test(value, recordFun)|trim}}{% if not loop.last %},{% endif %}
            {{"\n"}}
          {% endif %}
        {%- endfor -%}
      })
    {%- endset -%}

  {% else %}

    {%- set content -%}_reject('not configured'){% endset %}

  {% endif %}

  {% if hasTest(type) -%}

   {% set content -%}
    _and({{content}}, {{getTest(type)}})
   {%- endset %}

  {% endif %}

  {{ optional(type, content) }}

{% endmacro %}

{# 
  
  turn a sum schema into a precondition 
  @param {Schema} type
  @param {Precondition} recordFn

#}
{% macro sumType2Test (type, recordFn) %}

  {% if type.discriminator.type == 'rw' %}

    {%- set content -%}
     {{type2Test(type.variants.write, recordFn)}}
    {%- endset -%}

  {% elseif type.discriminator.type == 'shape' %}

    {%- set content -%}
    _match(
      {%- for key,variant in type.variants -%}

      {% set shape =  variant.discriminator %}
      {% set validator =  type2Test(variant,recordFn) %}
      _caseOf({{shape|dump}}, {{validator}}){% if not loop.last %},{% endif %}

      {%- endfor -%})
    {% endset %}

  {% else %}

    {% set json %}{{type|dump}}{% endset %}
    {{ 'sumType2Test: Unknown discriminator type '+ 
    type.discriminator.type+ ' in '+json | error }}

  {% endif %}

  {{ optional(type,content) | trim}}

{% endmacro %}

{#
  turns any schema type into a validator 

  @param {Schema} type
  @param {Precondition} recordFn

#}
{% macro anyType2Test(type) %}

    {% if hasTest(type) -%}

      {%- set content -%}{{getTest(type)}}{%- endset -%}
      {{ optional(type, content) | trim }}

    {%- else -%}

      _identity

    {%- endif -%}

{% endmacro %}

{# 
 
  turns a type into a precondition. 
  
  @param {Schema} type
  @param {Precondition} recordFn

#}
{% macro type2Test(type, recordFn="_restrict") %}

  {%- if isArrayType(type) -%}

    {{arrayType2Test(type,recordFn)}}

  {%- elseif isObjectType(type) -%}
    
    {{objectType2Test(type,recordFn) | trim }}

  {%- elseif isSumType(type) -%}

    {{sumType2Test(type,recordFn) | trim }}
    
  {%- else -%}

    {{anyType2Test(type,recordFn) | trim }}
    
  {%- endif -%}

{% endmacro %}
